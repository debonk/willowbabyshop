<modification>
	<id>Bonk08: Extended Admin Product List</id>
	<version>v2.2-2.0</version>
	<vqmver>2.5.1</vqmver>
	<author>Modification: Bonk:kumumufashion@gmail.com, dobv@seznam.cz, 27rusk@gmail.com</author>

	<file name="admin/controller/catalog/product.php">
		<operation>
            <search position="before" index="1,2,3,4,6,7,8,9"><![CDATA[
            if (isset($this->request->get['filter_status'])) {
            ]]></search>
            <add><![CDATA[			//Bonk08 - 1
			if (isset($this->request->get['filter_manufacturer'])) {
                $url .= '&filter_manufacturer=' . $this->request->get['filter_manufacturer'];
            }

			if (isset($this->request->get['filter_category'])) {
                $url .= '&filter_category=' . $this->request->get['filter_category'];
            }
			
			if (isset($this->request->get['filter_tag'])) {
				$url .= '&filter_tag=' . urlencode(html_entity_decode($this->request->get['filter_tag'], ENT_QUOTES, 'UTF-8'));
			}
			//Bonk08 - End
            ]]></add>
        </operation>

        <operation>
            <search position="before" index="5"><![CDATA[
            if (isset($this->request->get['filter_status'])) {
            ]]></search>
            <add><![CDATA[		//Bonk08 - 2
		if (isset($this->request->get['filter_manufacturer'])) {
			$filter_manufacturer = $this->request->get['filter_manufacturer'];
		} else {
			$filter_manufacturer = null;
		}
		
		if (isset($this->request->get['filter_category'])) {
			$filter_category = $this->request->get['filter_category'];
		} else {
			$filter_category = null;
		}

		if (isset($this->request->get['filter_tag'])) {
			$filter_tag = $this->request->get['filter_tag'];
		} else {
			$filter_tag = null;
		}
        //Bonk08 - End
            ]]></add>
        </operation>

        <operation>
            <search position="before"><![CDATA[
            'filter_status'   => $filter_status,
            ]]></search>
            <add><![CDATA[			'filter_manufacturer' => $filter_manufacturer,//Bonk08 - 3
			'filter_category' => $filter_category,//Bonk08 - 3
			'filter_tag'	  => $filter_tag,//Bonk08 - 3]]></add>
        </operation>

        <operation>
            <search position="after" index="1"><![CDATA[
            $results = $this->model_catalog_product->getProducts($filter_data);
            ]]></search>
            <add><![CDATA[
		//Bonk08 - 4
		$this->load->model('catalog/category');
		$data['categories'] = $this->model_catalog_category->getCategories(0);
		$this->load->model('catalog/manufacturer');
		$data['manufacturers'] = $this->model_catalog_manufacturer->getManufacturers(0);
		//Bonk08 - End]]></add>
        </operation>

        <operation>
            <search position="before"><![CDATA[
            if (is_file(DIR_IMAGE . $result['image'])) {
            ]]></search>
            <add><![CDATA[
            $category =  $this->model_catalog_product->getProductCategories($result['product_id']);//Bonk08 - 5
            ]]></add>
        </operation>

        <operation>
            <search position="after"><![CDATA[
            'price'      => $result['price'],
            ]]></search>
            <add><![CDATA[				'manufacturer'   => $result['manufacturer_name'],//Bonk08 - 6
				'category'   => $category,//Bonk08 - 6
				'tag'		 => $result['tag'],//Bonk08 - 6]]></add>
        </operation>

        <operation>
            <search position="after"><![CDATA[
            $data['column_price'] = $this->language->get('column_price');
            ]]></search>
            <add><![CDATA[		$data['column_product_id'] = $this->language->get('column_product_id');//Bonk08 - 7;
		$data['column_manufacturer'] = $this->language->get('column_manufacturer');//Bonk08 - 7
		$data['column_category'] = $this->language->get('column_category');//Bonk08 - 7
		$data['column_tag'] = $this->language->get('column_tag');//Bonk08 - 7]]></add>
        </operation>

        <operation>
            <search position="after"><![CDATA[
            $data['entry_price'] = $this->language->get('entry_price');
            ]]></search>
            <add><![CDATA[		$data['entry_all_manufacturer'] = $this->language->get('entry_all_manufacturer');//Bonk08 - 8
		$data['entry_all_category'] = $this->language->get('entry_all_category');//Bonk08 - 8
		$data['entry_tag'] = $this->language->get('entry_tag');//Bonk08 - 8]]></add>
        </operation>

        <operation>
            <search position="after"><![CDATA[
            $data['sort_price'] = $this->url->link('catalog/product', 'token=' . $this->session->data['token'] . '&sort=p.price' . $url, true);
            ]]></search>
            <add><![CDATA[		$data['sort_id'] = $this->url->link('catalog/product', 'token=' . $this->session->data['token'] . '&sort=p.product_id' . $url, true);//Bonk08 - 9
		$data['sort_manufacturer'] = $this->url->link('catalog/product', 'token=' . $this->session->data['token'] . '&sort=manufacturer_name' . $url, true);//Bonk08 - 9
		$data['sort_category'] = $this->url->link('catalog/product', 'token=' . $this->session->data['token'] . '&sort=p2c.category_id' . $url, true);//Bonk08 - 9
		$data['sort_tag'] = $this->url->link('catalog/product', 'token=' . $this->session->data['token'] . '&sort=pd.tag' . $url, true);//Bonk08 - 9]]></add>
        </operation>

        <operation>
            <search position="before"><![CDATA[
            $data['filter_price'] = $filter_price;
            ]]></search>
            <add><![CDATA[		$data['filter_manufacturer'] = $filter_manufacturer;//Bonk08 - 10
		$data['filter_category'] = $filter_category;//Bonk08 - 10
		$data['filter_tag'] = $filter_tag;//Bonk08 - 10]]></add>
        </operation>
	</file>

	<file name="admin/language/en-gb/catalog/product.php">
        <operation>
            <search position="after"><![CDATA[
            $_['column_price']
            ]]></search>
            <add><![CDATA[$_['column_product_id']    	 = 'ID';//Bonk08 - 21
$_['column_manufacturer']    = 'Brand';//Bonk08 - 21
$_['column_category']        = 'Category';//Bonk08 - 21
$_['column_tag']             = 'Tags';//Bonk08 - 21]]></add>
        </operation>
		
        <operation>
            <search position="after"><![CDATA[
            $_['entry_recurring']
            ]]></search>
            <add><![CDATA[$_['entry_all_manufacturer'] = '--- All Brands ---';//Bonk08 - 22
$_['entry_all_category']     = '--- All Categories ---';//Bonk08 - 22]]></add>
        </operation>
		
	</file>

	<file name="admin/model/catalog/product.php">
	
		<operation>
            <search position="replace"><![CDATA[
            $sql = "SELECT * FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) WHERE pd.language_id = '" . (int)$this->config->get('config_language_id') . "'";
            ]]></search>
            <add><![CDATA[//Bonk08-31
		//$sql = "SELECT * FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) LEFT JOIN " . DB_PREFIX . "product_to_category p2c ON (p.product_id = p2c.product_id) WHERE pd.language_id = '" . (int)$this->config->get('config_language_id') . "'";
		$sql = "SELECT p.*, pd.*, p2c.category_id, m.name AS manufacturer_name FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) LEFT JOIN " . DB_PREFIX . "product_to_category p2c ON (p.product_id = p2c.product_id) LEFT JOIN " . DB_PREFIX . "manufacturer m ON (p.manufacturer_id = m.manufacturer_id) WHERE pd.language_id = '" . (int)$this->config->get('config_language_id') . "'";
		//Bonk08-End]]></add>
        </operation>
		
        <operation error="skip">
            <search position="before"><![CDATA[
            $sql .= " GROUP BY p.product_id";
            ]]></search>
            <add><![CDATA[		//Bonk08-32
		if (!empty($data['filter_tag'])) {
			$sql .= " AND pd.tag LIKE '%" . $this->db->escape($data['filter_tag']) . "%'";
		}

		if (isset($data['filter_manufacturer']) && !is_null($data['filter_manufacturer'])) {
			$sql .= " AND p.manufacturer_id = '" . (int)$data['filter_manufacturer'] . "'";
		}

		if (!empty($data['filter_category'])) {
			if (!empty($data['filter_sub_category'])) {
				$implode_data = array();
				
				$implode_data[] = "category_id = '" . (int)$data['filter_category'] . "'";
				
				$this->load->model('catalog/category');
				
				$categories = $this->model_catalog_category->getCategories($data['filter_category']);
				
				foreach ($categories as $category) {
					$implode_data[] = "p2c.category_id = '" . (int)$category['category_id'] . "'";
				}
				
				$sql .= " AND (" . implode(' OR ', $implode_data) . ")";			
			} else {
				$sql .= " AND p2c.category_id = '" . (int)$data['filter_category'] . "'";
			}
		}
		//Bonk08-32]]></add>
        </operation>
        
		<operation error="skip">
            <search position="after"><![CDATA[
            'p.price',
            ]]></search>
            <add><![CDATA[			'p.product_id',//Bonk08-33
			'pd.tag',//Bonk08-33
			'manufacturer_name',//Bonk08-33
			'p2c.category_id',//Bonk08-33]]></add>
        </operation>
		
		<operation error="skip">
            <search position="replace"><![CDATA[
            $sql = "SELECT COUNT(DISTINCT p.product_id) AS total FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id)";
            ]]></search>
            <add><![CDATA[
		//Bonk08-34
		//$sql = "SELECT COUNT(DISTINCT p.product_id) AS total FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id)";
		$sql = "SELECT COUNT(DISTINCT p.product_id) AS total FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) LEFT JOIN " . DB_PREFIX . "product_to_category p2c ON (p.product_id = p2c.product_id)";
		//Bonk08-End]]></add>
        </operation>
		
		<operation error="skip">
            <search position="before" index="2"><![CDATA[
            if (isset($data['filter_status']) && !is_null($data['filter_status'])) {
            ]]></search>
            <add><![CDATA[		//Bonk08-35
		if (!empty($data['filter_tag'])) {
			$sql .= " AND pd.tag LIKE '%" . $this->db->escape($data['filter_tag']) . "%'";
		}
		
		if (isset($data['filter_manufacturer']) && !is_null($data['filter_manufacturer'])) {
			$sql .= " AND p.manufacturer_id = '" . (int)$data['filter_manufacturer'] . "'";
		}

		if (isset($data['filter_category']) && !is_null($data['filter_category'])) {
			$sql .= " AND p2c.category_id = '" . (int)$data['filter_category'] . "'";
		}
		//Bonk08-End
			]]></add>
        </operation>
		
		<operation>
			<search position="replace"><![CDATA[ $sql .= " AND pd.name LIKE ']]></search>
			<add><![CDATA[ $sql .= " AND pd.name LIKE '%]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[ $sql .= " AND p.model LIKE ']]></search>
			<add><![CDATA[ $sql .= " AND p.model LIKE '%]]></add>
		</operation>
	</file>
	
	<file name="admin/view/template/catalog/product_list.tpl">
        <operation>
            <search position="before"><![CDATA[
            <td class="text-right"><?php if ($sort == 'p.price') { ?>
            ]]></search>
            <add><![CDATA[				  <!--Bonk08-->
                  <td class="text-left"><?php if ($sort == 'pd.tag') { ?>
                    <a href="<?php echo $sort_tag; ?>" class="<?php echo strtolower($order); ?>"><?php echo $column_tag; ?></a>
                  <?php } else { ?>
                    <a href="<?php echo $sort_tag; ?>"><?php echo $column_tag; ?></a>
                  <?php } ?></td>
				  <td class="text-left"><?php if ($sort == 'manufacturer_name') { ?>
					<a href="<?php echo $sort_manufacturer; ?>" class="<?php echo strtolower($order); ?>"><?php echo $column_manufacturer; ?></a>
				  <?php } else { ?>
					<a href="<?php echo $sort_manufacturer; ?>"><?php echo $column_manufacturer; ?></a>
			      <?php } ?></td>
				  <td class="text-left"><?php if ($sort == 'p2c.category_id') { ?>
					<a href="<?php echo $sort_category; ?>" class="<?php echo strtolower($order); ?>"><?php echo $column_category; ?></a>
				  <?php } else { ?>
					<a href="<?php echo $sort_category; ?>"><?php echo $column_category; ?></a>
			      <?php } ?></td>
			]]></add>
        </operation>
		
		<operation>
            <search position="before"><![CDATA[
            <td class="text-right"><?php if ($product['special']) { ?>
            ]]></search>
            <add><![CDATA[				  <!--Bonk08-->
                  <td class="text-left"><?php echo $product['tag']; ?></td>
				  <td class="text-left"><?php echo $product['manufacturer'];?></td>
				  <td class="text-left">
					<?php foreach ($categories as $category) { ?>
						<?php if (in_array($category['category_id'], $product['category'])) { ?>
						<?php echo $category['name'];?><br>
					<?php } ?> <?php } ?>
				  </td>
            ]]></add>
        </operation>

        <operation>
            <search position="replace" index="1,2,3"><![CDATA[
            <div class="col-sm-4">
            ]]></search>
            <add><![CDATA[<div class="col-sm-3">]]></add>
        </operation>

        <operation>
            <search position="before" index="3"><![CDATA[
            <div class="col-sm-3">
            ]]></search>
            <add><![CDATA[
			<div class="col-sm-3">
			  <div class="form-group">
			  <label class="control-label" for="input-manufacturer"><?php echo $column_manufacturer; ?></label>
			  <select name="filter_manufacturer" id="input-manufacturer" class="form-control">
              <option value="*"><?php echo $entry_all_manufacturer; ?></option>
              <?php foreach ($manufacturers as $manufacturer) { ?>
                <?php if ($manufacturer['manufacturer_id']==$filter_manufacturer) { ?>
                  <option value="<?php echo $manufacturer['manufacturer_id']; ?>" selected="selected"><?php echo $manufacturer['name']; ?></option>
                <?php } else { ?>
                  <option value="<?php echo $manufacturer['manufacturer_id']; ?>"><?php echo $manufacturer['name']; ?></option> 
                <?php } ?>
              <?php } ?>
              </select>
			  </div>

			  <div class="form-group">
			  <label class="control-label" for="input-category"><?php echo $column_category; ?></label>
			  <select name="filter_category" id="input-category" class="form-control">
              <option value="*"><?php echo $entry_all_category; ?></option>
              <?php foreach ($categories as $category) { ?>
                <?php if ($category['category_id']==$filter_category) { ?>
                  <option value="<?php echo $category['category_id']; ?>" selected="selected"><?php echo $category['name']; ?></option>
                <?php } else { ?>
                  <option value="<?php echo $category['category_id']; ?>"><?php echo $category['name']; ?></option> 
                <?php } ?>
              <?php } ?>
              </select>
			  </div>

			</div>]]></add>
        </operation>

        <operation>
            <search position="before"><![CDATA[
            <button type="button" id="button-filter" class="btn btn-primary pull-right"><i class="fa fa-search"></i> <?php echo $button_filter; ?></button>
            ]]></search>
            <add><![CDATA[
              <div class="form-group">
                <label class="control-label" for="input-tag"><?php echo $entry_tag; ?></label>
                <input type="text" name="filter_tag" value="<?php echo $filter_tag; ?>" placeholder="<?php echo $entry_tag; ?>" id="input-tag" class="form-control" />
              </div>
            ]]></add>
        </operation>

        <operation>
            <search position="before"><![CDATA[
			var filter_price = $('input[name=\'filter_price\']').val();
            ]]></search>
            <add><![CDATA[	var filter_tag = $('input[name=\'filter_tag\']').val();

	if (filter_tag) {
		url += '&filter_tag=' + encodeURIComponent(filter_tag);
	}

	var filter_manufacturer = $('select[name=\'filter_manufacturer\']').val();
	
	if (filter_manufacturer != '*') {
		url += '&filter_manufacturer=' + encodeURIComponent(filter_manufacturer);
	}

	var filter_category = $('select[name=\'filter_category\']').val();
	
	if (filter_category != '*') {
		url += '&filter_category=' + encodeURIComponent(filter_category);
	}
            ]]></add>
        </operation>
		
		<operation>
			<search position="replace"><![CDATA[<td style="width: 1px;" class="text-center"><input type="checkbox" onclick="$('input[name*=\'selected\']').prop('checked', this.checked);" /></td>]]></search>
			<add><![CDATA[<td style="width: 1px;" class="text-center"><input type="checkbox" onclick="$('input[name*=\'selected\']').prop('checked', this.checked);" /><br>
					<?php if ($sort == 'p.product_id') { ?>
					  <a href="<?php echo $sort_id; ?>" class="<?php echo strtolower($order); ?>"><?php echo $column_product_id; ?></a>
					<?php } else { ?>
					  <a href="<?php echo $sort_id; ?>"><?php echo $column_product_id; ?></a>
					<?php } ?></td>]]></add>
		</operation>

	</file>
</modification>